# render.yaml - Render Blueprint for CoP Pipeline
# One file to deploy everything!

services:
  # Main Web UI Service
  - type: web
    name: cop-redteam-ui
    runtime: docker
    dockerfilePath: ./Dockerfile.render
    envVars:
      # API Keys (add these in Render dashboard)
      - key: XAI_API_KEY
        sync: false
      - key: OPENAI_API_KEY
        sync: false
      - key: ANTHROPIC_API_KEY
        sync: false
      - key: GOOGLE_API_KEY
        sync: false
      - key: TOGETHER_API_KEY
        sync: false
      
      # Database (auto-filled by Render)
      - key: DATABASE_URL
        fromDatabase:
          name: cop-postgres
          property: connectionString
      
      # Parse DATABASE_URL into individual components for legacy compatibility
      - key: POSTGRES_HOST
        fromDatabase:
          name: cop-postgres
          property: host
      - key: POSTGRES_PORT
        fromDatabase:
          name: cop-postgres
          property: port
      - key: POSTGRES_USER
        fromDatabase:
          name: cop-postgres
          property: user
      - key: POSTGRES_PASSWORD
        fromDatabase:
          name: cop-postgres
          property: password
      - key: POSTGRES_DB
        fromDatabase:
          name: cop-postgres
          property: database
      
      # Redis (auto-filled by Render)
      - key: REDIS_URL
        fromService:
          type: redis
          name: cop-redis
          property: connectionString
      
      # Parse REDIS_URL into individual components
      - key: REDIS_HOST
        fromService:
          type: redis
          name: cop-redis
          property: host
      - key: REDIS_PORT
        fromService:
          type: redis
          name: cop-redis
          property: port
      - key: REDIS_PASSWORD
        fromService:
          type: redis
          name: cop-redis
          property: password
      
      # Pipeline Configuration
      - key: MAX_ITERATIONS
        value: "10"
      - key: JAILBREAK_THRESHOLD
        value: "8.0"
      - key: SIMILARITY_THRESHOLD
        value: "1.0"
      - key: DEFAULT_RED_TEAMING_AGENT
        value: "grok-2"
      - key: DEFAULT_JUDGE_LLM
        value: "gpt-4o"
      - key: MAX_CONCURRENT_REQUESTS
        value: "5"
      - key: LOG_LEVEL
        value: "INFO"
      
      # Render-specific
      - key: PORT
        value: "7860"
      - key: PYTHON_VERSION
        value: "3.11.8"
    
    # Health check
    healthCheckPath: /
    
    # Auto-deploy on git push
    autoDeploy: true
    
    # Resources (adjust based on needs)
    plan: free  # Free tier (512MB RAM, 0.5 CPU) - Note: service sleeps after 15min inactivity
    # plan: starter  # $7/mo (512MB RAM, 0.5 CPU) - Always on, no sleep
    # plan: standard  # $25/mo (2GB RAM, 1 CPU)
    # plan: pro  # $85/mo (4GB RAM, 2 CPU)

  # Redis Cache
  - type: redis
    name: cop-redis
    plan: free  # Free tier: 25MB, expires after 90 days
    # plan: starter  # $10/mo: 256MB, persistent
    maxmemoryPolicy: allkeys-lru
    ipAllowList: []

databases:
  # PostgreSQL Database
  - name: cop-postgres
    databaseName: cop_pipeline
    user: cop_user
    plan: free  # Free tier: 1GB storage, expires after 90 days
    # plan: standard  # $7/mo: 10GB, persistent, auto backups
    ipAllowList: []  # Empty = allow all (or restrict to your IPs)